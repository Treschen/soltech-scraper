{
  "name": "Solutiontech Ingest (Complete)",
  "nodes": [
    {
      "parameters": {
        "path": "solutiontech_ingest",
        "httpMethod": "POST",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook",
      "name": "Webhook - Receive Products",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "statusCode": 200,
        "body": "={{ { ok: true, received: $json.count || $items().length } }}"
      },
      "id": "respond",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [460, 300]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "batch_id",
              "name": "batchId",
              "value": "={{ $json.batchId }}",
              "type": "string"
            },
            {
              "id": "batch_index",
              "name": "batchIndex",
              "value": "={{ $json.index }}",
              "type": "number"
            },
            {
              "id": "total_batches",
              "name": "totalBatches",
              "value": "={{ $json.totalBatches }}",
              "type": "number"
            },
            {
              "id": "items",
              "name": "items",
              "value": "={{ $json.items }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "id": "extract_batch",
      "name": "Extract Batch Metadata",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [680, 300]
    },
    {
      "parameters": {
        "fieldToSplitOut": "items",
        "options": {}
      },
      "id": "split_items",
      "name": "Split Into Items",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [900, 300]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "source_url",
              "name": "sourceUrl",
              "value": "={{ $json.url }}",
              "type": "string"
            },
            {
              "id": "source_sku",
              "name": "sourceSku",
              "value": "={{ $json.sku }}",
              "type": "string"
            },
            {
              "id": "source_title",
              "name": "sourceTitle",
              "value": "={{ $json.title }}",
              "type": "string"
            },
            {
              "id": "source_price",
              "name": "sourcePrice",
              "value": "={{ $json.price }}",
              "type": "number"
            },
            {
              "id": "source_vendor",
              "name": "sourceVendor",
              "value": "={{ $json.vendor || 'Solution Technologies' }}",
              "type": "string"
            },
            {
              "id": "source_availability",
              "name": "sourceAvailability",
              "value": "={{ $json.availability }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "normalize_product",
      "name": "Normalize Product Data",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "resource": "product",
        "operation": "getAll",
        "returnAll": false,
        "limit": 10,
        "options": {
          "sku": "={{ $json.sourceSku }}"
        }
      },
      "id": "search_shopify",
      "name": "Search Shopify by SKU",
      "type": "n8n-nodes-base.shopify",
      "typeVersion": 1,
      "position": [1340, 300],
      "credentials": {
        "shopifyApi": {
          "id": "YOUR_SHOPIFY_CREDENTIAL_ID",
          "name": "Shopify stponline"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has_product",
              "leftValue": "={{ $items('search_shopify').length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "route_exists",
      "name": "Product Exists?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [1560, 300]
    },
    {
      "parameters": {
        "jsCode": "// Get the product from Shopify search\nconst shopifyProduct = $input.first().json;\nconst sourceData = $('normalize_product').first().json;\n\n// Calculate markup (15% + VAT)\nconst costPrice = parseFloat(sourceData.sourcePrice) || 0;\nconst markup = 1.15; // 15% markup\nconst priceExVat = costPrice * markup;\nconst priceIncVat = priceExVat * 1.15; // Add 15% VAT\n\n// Determine inventory based on availability\nlet inventoryQty = 0;\nif (sourceData.sourceAvailability) {\n  const avail = sourceData.sourceAvailability.toLowerCase();\n  if (avail.includes('instock')) inventoryQty = 10;\n  else if (avail.includes('outofstock')) inventoryQty = 0;\n  else inventoryQty = 5; // Unknown\n}\n\n// Find variant with matching SKU\nconst variant = shopifyProduct.variants?.find(v => v.sku === sourceData.sourceSku) || shopifyProduct.variants?.[0];\n\nif (!variant) {\n  throw new Error(`No variant found for SKU ${sourceData.sourceSku}`);\n}\n\nreturn {\n  json: {\n    productId: shopifyProduct.id,\n    variantId: variant.id,\n    inventoryItemId: variant.inventory_item_id,\n    currentPrice: variant.price,\n    newPrice: priceIncVat.toFixed(2),\n    currentInventory: variant.inventory_quantity || 0,\n    newInventory: inventoryQty,\n    sku: sourceData.sourceSku,\n    title: shopifyProduct.title,\n    needsPriceUpdate: Math.abs(parseFloat(variant.price) - priceIncVat) > 0.01,\n    needsInventoryUpdate: (variant.inventory_quantity || 0) !== inventoryQty\n  }\n};"
      },
      "id": "calc_updates",
      "name": "Calculate Updates",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1780, 200]
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "=https://{{ $env.SHOPIFY_SHOP }}.myshopify.com/admin/api/2024-10/variants/{{ $json.variantId }}.json",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "shopifyApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "variant",
              "value": "={{ { id: $json.variantId, price: $json.newPrice } }}"
            }
          ]
        },
        "options": {}
      },
      "id": "update_price",
      "name": "Update Price",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2000, 100],
      "executeOnce": false,
      "credentials": {
        "shopifyApi": {
          "id": "YOUR_SHOPIFY_CREDENTIAL_ID",
          "name": "Shopify stponline"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://{{ $env.SHOPIFY_SHOP }}.myshopify.com/admin/api/2024-10/inventory_levels/set.json",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "shopifyApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "inventory_item_id",
              "value": "={{ $('calc_updates').item.json.inventoryItemId }}"
            },
            {
              "name": "location_id",
              "value": "={{ $env.SHOPIFY_LOCATION_ID }}"
            },
            {
              "name": "available",
              "value": "={{ $('calc_updates').item.json.newInventory }}"
            }
          ]
        },
        "options": {}
      },
      "id": "update_inventory",
      "name": "Update Inventory",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2000, 300],
      "executeOnce": false,
      "credentials": {
        "shopifyApi": {
          "id": "YOUR_SHOPIFY_CREDENTIAL_ID",
          "name": "Shopify stponline"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition",
        "options": {}
      },
      "id": "merge_results",
      "name": "Merge Update Results",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [2220, 200]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "status",
              "name": "status",
              "value": "updated",
              "type": "string"
            },
            {
              "id": "sku",
              "name": "sku",
              "value": "={{ $('calc_updates').item.json.sku }}",
              "type": "string"
            },
            {
              "id": "title",
              "name": "title",
              "value": "={{ $('calc_updates').item.json.title }}",
              "type": "string"
            },
            {
              "id": "price_updated",
              "name": "priceUpdated",
              "value": "={{ $('calc_updates').item.json.needsPriceUpdate }}",
              "type": "boolean"
            },
            {
              "id": "inventory_updated",
              "name": "inventoryUpdated",
              "value": "={{ $('calc_updates').item.json.needsInventoryUpdate }}",
              "type": "boolean"
            },
            {
              "id": "new_price",
              "name": "newPrice",
              "value": "={{ $('calc_updates').item.json.newPrice }}",
              "type": "string"
            },
            {
              "id": "new_inventory",
              "name": "newInventory",
              "value": "={{ $('calc_updates').item.json.newInventory }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "id": "format_update_result",
      "name": "Format Update Result",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [2440, 200]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "status",
              "name": "status",
              "value": "new_product",
              "type": "string"
            },
            {
              "id": "sku",
              "name": "sku",
              "value": "={{ $('normalize_product').item.json.sourceSku }}",
              "type": "string"
            },
            {
              "id": "title",
              "name": "title",
              "value": "={{ $('normalize_product').item.json.sourceTitle }}",
              "type": "string"
            },
            {
              "id": "message",
              "name": "message",
              "value": "Routed to new product workflow (not implemented)",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "format_new_result",
      "name": "Format New Product Result",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1780, 400]
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition",
        "options": {}
      },
      "id": "merge_all",
      "name": "Merge All Results",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [2660, 300]
    },
    {
      "parameters": {
        "operation": "aggregate",
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "id": "aggregate",
      "name": "Aggregate Results",
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [2880, 300]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nconst updated = items.filter(i => i.json.status === 'updated');\nconst newProducts = items.filter(i => i.json.status === 'new_product');\nconst priceChanges = updated.filter(i => i.json.priceUpdated);\nconst inventoryChanges = updated.filter(i => i.json.inventoryUpdated);\n\nconst summary = {\n  totalProcessed: items.length,\n  updated: updated.length,\n  newProducts: newProducts.length,\n  priceChanges: priceChanges.length,\n  inventoryChanges: inventoryChanges.length,\n  timestamp: new Date().toISOString(),\n  details: {\n    updated: updated.map(i => ({\n      sku: i.json.sku,\n      title: i.json.title,\n      priceUpdated: i.json.priceUpdated,\n      inventoryUpdated: i.json.inventoryUpdated,\n      newPrice: i.json.newPrice,\n      newInventory: i.json.newInventory\n    })),\n    newProducts: newProducts.map(i => ({\n      sku: i.json.sku,\n      title: i.json.title\n    }))\n  }\n};\n\nreturn { json: summary };"
      },
      "id": "build_summary",
      "name": "Build Summary",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3100, 300]
    },
    {
      "parameters": {
        "select": "channel",
        "channelId": {
          "__rl": true,
          "value": "YOUR_SLACK_CHANNEL_ID",
          "mode": "list",
          "cachedResultName": "#general"
        },
        "text": "=*Solution Technologies Product Sync Complete*\n\nüìä *Summary*\n‚Ä¢ Total Processed: {{ $json.totalProcessed }}\n‚Ä¢ Updated: {{ $json.updated }}\n‚Ä¢ New Products: {{ $json.newProducts }}\n‚Ä¢ Price Changes: {{ $json.priceChanges }}\n‚Ä¢ Inventory Changes: {{ $json.inventoryChanges }}\n\n{{ $json.updated > 0 ? '‚úÖ *Updated Products:*\\n' + $json.details.updated.map(p => `‚Ä¢ ${p.sku}: ${p.title}${p.priceUpdated ? ' (Price: R' + p.newPrice + ')' : ''}${p.inventoryUpdated ? ' (Stock: ' + p.newInventory + ')' : ''}`).join('\\n') : '' }}\n\n{{ $json.newProducts > 0 ? 'üÜï *New Products:*\\n' + $json.details.newProducts.map(p => `‚Ä¢ ${p.sku}: ${p.title}`).join('\\n') : '' }}\n\n‚è∞ {{ $json.timestamp }}",
        "otherOptions": {}
      },
      "id": "send_slack",
      "name": "Send Slack Summary",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.2,
      "position": [3320, 300],
      "credentials": {
        "slackApi": {
          "id": "YOUR_SLACK_CREDENTIAL_ID",
          "name": "Slack account"
        }
      }
    }
  ],
  "connections": {
    "Webhook - Receive Products": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          },
          {
            "node": "Extract Batch Metadata",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Batch Metadata": {
      "main": [
        [
          {
            "node": "Split Into Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Into Items": {
      "main": [
        [
          {
            "node": "Normalize Product Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize Product Data": {
      "main": [
        [
          {
            "node": "Search Shopify by SKU",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search Shopify by SKU": {
      "main": [
        [
          {
            "node": "Product Exists?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Product Exists?": {
      "main": [
        [
          {
            "node": "Calculate Updates",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format New Product Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculate Updates": {
      "main": [
        [
          {
            "node": "Update Price",
            "type": "main",
            "index": 0
          },
          {
            "node": "Update Inventory",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Price": {
      "main": [
        [
          {
            "node": "Merge Update Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Inventory": {
      "main": [
        [
          {
            "node": "Merge Update Results",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Update Results": {
      "main": [
        [
          {
            "node": "Format Update Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Update Result": {
      "main": [
        [
          {
            "node": "Merge All Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format New Product Result": {
      "main": [
        [
          {
            "node": "Merge All Results",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge All Results": {
      "main": [
        [
          {
            "node": "Aggregate Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate Results": {
      "main": [
        [
          {
            "node": "Build Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Summary": {
      "main": [
        [
          {
            "node": "Send Slack Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-11-08T00:00:00.000Z",
  "versionId": "1"
}
